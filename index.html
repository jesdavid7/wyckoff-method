<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expanded Trading Analysis</title>
    <!-- Use the Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.3s ease;
        }

        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        #chart-display {
            max-height: 500px;
            object-fit: contain;
            width: 100%;
            height: auto;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <div class="card p-6 md:p-10 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Expanded Trading Analysis</h1>
            <p class="text-gray-500 mb-6 sm:mb-8">Upload a chart image, and I will analyze it using the Gemini API to identify the Wyckoff phase, support/resistance levels, Ichimoku, and a Buy/Sell/Hold analysis.</p>

            <!-- File Upload and Display Section -->
            <div class="mb-8">
                <input 
                    type="file" 
                    id="chart-input" 
                    accept="image/*" 
                    class="hidden" 
                    onchange="handleFileSelect(event)"
                />
                <button 
                    onclick="document.getElementById('chart-input').click()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                >
                    Upload and Analyze Chart
                </button>
            </div>

            <div id="chart-container" class="relative bg-gray-100 rounded-lg p-4 flex items-center justify-center hidden">
                <img id="chart-display" src="#" alt="Uploaded Chart" class="rounded-lg shadow-inner">
                <div id="loading-spinner" class="loader hidden absolute"></div>
            </div>

            <!-- Analysis Results Section -->
            <div id="analysis-results" class="mt-8 text-left hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Analysis Results</h2>
                <div id="result-content" class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <p class="text-gray-600">The analysis will appear here. The bot will identify the Wyckoff market phase and key support and resistance levels.</p>
                </div>
            </div>
            
            <div id="error-message" class="mt-4 hidden p-4 bg-red-100 text-red-700 rounded-lg"></div>
        </div>
    </div>

    <script>
        // --- Firebase boilerplate for Canvas environment. Not used in this specific app logic. ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // -------------------------------------------------------------------------------------

        const chartInput = document.getElementById('chart-input');
        const chartContainer = document.getElementById('chart-container');
        const chartDisplay = document.getElementById('chart-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const analysisResults = document.getElementById('analysis-results');
        const resultContent = document.getElementById('result-content');
        const errorMessageDiv = document.getElementById('error-message');

        /**
         * Converts a File object to a Base64 string.
         * @param {File} file The file to convert.
         * @returns {Promise<string>} A promise that resolves with the Base64 data.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Handles the file selection event and initiates the analysis.
         * @param {Event} event The file input change event.
         */
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            hideErrorMessage();
            // Show the loading spinner and chart container
            chartContainer.classList.remove('hidden');
            analysisResults.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                chartDisplay.src = e.target.result;
            };
            reader.readAsDataURL(file);

            try {
                const base64Data = await fileToBase64(file);
                await analyzeChart(base64Data, file.type);
            } catch (error) {
                console.error("Error during analysis:", error);
                showErrorMessage("Failed to analyze chart. Please try again.");
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Sends the chart image to the Gemini API for Wyckoff analysis.
         * @param {string} imageData The Base64-encoded image data.
         * @param {string} mimeType The MIME type of the image.
         */
        async function analyzeChart(imageData, mimeType) {
            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=" + apiKey;

            const imageAnalysisPrompt = `Act as a professional financial analyst. Analyze the provided stock or crypto chart image.
            
            First, perform a Wyckoff Method analysis. Identify and explain the current Wyckoff market phase (e.g., Accumulation, Distribution, Re-accumulation, Re-distribution). Point out any specific Wyckoff events visible on the chart, such as a Selling Climax (SC), Automatic Rally (AR), Secondary Test (ST), Spring, Sign of Strength (SOS), Buying Climax (BC), Automatic Reaction (AR), Upthrust (UT), or Sign of Weakness (SOW).
            
            Second, analyze the key support and resistance levels on the chart. Identify at least two significant support levels and two significant resistance levels, and provide a brief explanation for each.
            
            Third, analyze the Ichimoku Kinko Hyo. Interpret the relationship between the price and the Ichimoku cloud (Kumo), the Tenkan-sen and Kijun-sen lines, and the Chikou Span. Describe what the Ichimoku indicates about trend, momentum, and potential reversal signals.
            
            Finally, based on your combined analysis of the Wyckoff phase, the support/resistance levels, and the Ichimoku, provide a final "Buy," "Sell," or "Hold" recommendation. Be sure to provide a clear justification for your recommendation in a separate paragraph.
            
            Combine all four analyses into a single, comprehensive report in a conversational and easy-to-understand format. Do not include a disclaimer.`;

            const payload = {
                contents: [{
                    parts: [
                        { text: imageAnalysisPrompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: imageData
                            }
                        }
                    ]
                }]
            };

            let response;
            try {
                // Use exponential backoff for retries
                for (let i = 0; i < 3; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status !== 429) {
                        break;
                    }
                    console.log(`Rate limit hit, retrying in ${Math.pow(2, i)}s...`);
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }
            } catch (err) {
                console.error("Network or API error:", err);
                showErrorMessage(`Technical analysis failed: Could not connect to the service. Error: ${err.message}. Please try again.`);
                loadingSpinner.classList.add('hidden');
                return;
            }

            const result = await response.json();
            loadingSpinner.classList.add('hidden');
            analysisResults.classList.remove('hidden');

            const analysisText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (analysisText) {
                renderAnalysis(analysisText);
            } else {
                console.error("Invalid response from API:", result);
                showErrorMessage("Analysis failed. The AI could not process the chart. Please try a clearer or different image.");
            }
        }

        /**
         * Renders the analysis results in the UI.
         * @param {string} analysisHtml The HTML content to display.
         */
        function renderAnalysis(analysisText) {
            // Replaces newlines with paragraph tags for better formatting.
            const formattedText = analysisText.split('\n\n').map(p => `<p class="mb-4">${p.trim()}</p>`).join('');
            resultContent.innerHTML = formattedText;
        }
        
        /**
         * Displays an error message to the user.
         * @param {string} message The message to display.
         */
        function showErrorMessage(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        /**
         * Hides the error message.
         */
        function hideErrorMessage() {
            errorMessageDiv.classList.add('hidden');
        }
    </script>
</body>
</html>
